// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== SALES CHANNELS ====================

// Channel Type enum
enum ChannelType {
  POS         // Point of Sale (built-in)
  MARKETPLACE // Tokopedia, Shopee, Lazada, etc
  WEBSITE     // E-commerce website sendiri
  SOCIAL      // WhatsApp, Instagram, etc
  OTHER       // Manual input, etc
}

// Unified Transaction Status
enum TransactionStatus {
  PENDING     // Menunggu pembayaran/konfirmasi
  ONPROCESS   // Sedang diproses/dikemas
  SHIPPED     // Dalam pengiriman
  COMPLETED   // Selesai
  CANCELLED   // Dibatalkan
}

// Sales Channel - configurable marketplace/channel
model SalesChannel {
  id           String      @id @default(cuid())
  code         String      @unique @db.VarChar(50)  // "POS", "TOKOPEDIA", "SHOPEE", etc
  name         String      @db.VarChar(100)          // Display name
  type         ChannelType @default(MARKETPLACE)
  icon         String?     @db.VarChar(255)          // Icon name atau URL
  color        String?     @db.VarChar(20)           // Brand color hex
  isActive     Boolean     @default(true)
  isBuiltIn    Boolean     @default(false) // POS = true
  
  // Integration config (encrypted in production)
  apiConfig    Json?       // { apiKey, secretKey, shopId, refreshToken, etc }
  
  // Field mapping for data transformation
  fieldMapping Json?       // { "orderId": "order_sn", "status": "order_status" }
  
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  transactions  Transaction[]
  channelStocks ChannelStock[]

  @@map("sales_channels")
}

// Channel Stock - stock allocation per channel
model ChannelStock {
  id               String         @id @default(cuid())
  channel          SalesChannel   @relation(fields: [channelId], references: [id])
  channelId        String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  productVariantId String
  
  allocatedQty     Int            @default(0)  // Stock dialokasikan ke channel ini
  reservedQty      Int            @default(0)  // Stock di-reserve (checkout tapi belum bayar)
  soldQty          Int            @default(0)  // Total terjual via channel ini
  
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([channelId, productVariantId])
  @@index([channelId])
  @@index([productVariantId])
  @@map("channel_stocks")
}


// ==================== MULTI-TENANT ====================

model Tenant {
  id               String    @id @default(cuid())
  name             String    @db.VarChar(100) // Business/Store name (editable with restrictions)
  slug             String    @unique @db.VarChar(100) // URL-friendly identifier
  isActive         Boolean   @default(true)
  lastNameChangeAt DateTime? // Track when name was last changed (for 30-day rule)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  users      User[]
  cabangs    Cabang[]
  categories Category[]
  products   Product[]
  settings   Settings[]
  
  @@map("tenants")
}

// Audit Log for critical actions
model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String?
  cabangId    String?
  userId      String?
  action      String   @db.VarChar(100) // e.g. "STOCK_ADJUSTMENT", "RETURN_APPROVED"
  entityType  String   @db.VarChar(50)  // e.g. "Stock", "Return", "User"
  entityId    String   @db.VarChar(50)  // e.g. stockAdjustmentId, returnId, userId
  description String?  @db.VarChar(500) // Human readable description
  metadata    Json?    // Extra data snapshot
  ip          String?  @db.VarChar(50)
  createdAt   DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([cabangId, createdAt])
  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

// ==================== USER MANAGEMENT ====================

// User Management
model User {
  id        String   @id @default(cuid())
  // Tenant relation
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId  String
  
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  name      String   @db.VarChar(100)
  role      UserRole @default(KASIR)
  cabang    Cabang?  @relation(fields: [cabangId], references: [id])
  cabangId  String?
  
  // Multi-cabang access (ADMIN/MANAGER can access all cabangs if true)
  hasMultiCabangAccess Boolean @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions       Transaction[]
  processedReturns   Return[]
  requestedOrders    Order[]          @relation("RequestedOrders")
  processedOrders    Order[]          @relation("ProcessedOrders")
  stockTransfers     StockTransfer[]
  stockAdjustments   StockAdjustment[]
  recordedCashTransactions CashTransaction[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([cabangId])
  @@index([tenantId, isActive])
  @@map("users")
}

enum UserRole {
  OWNER
  MANAGER
  ADMIN
  KASIR
}

// Return/Refund Management
model Return {
  id              String       @id @default(cuid())
  returnNo        String       @unique @db.VarChar(50) // RET-20251124-0001
  transaction     Transaction  @relation(fields: [transactionId], references: [id])
  transactionId   String
  cabang          Cabang       @relation(fields: [cabangId], references: [id])
  cabangId        String
  processedBy     User         @relation(fields: [processedById], references: [id])
  processedById   String
  reason          ReturnReason
  reasonDetail    String?      @db.VarChar(500) // Additional details about the reason
  notes           String?      @db.VarChar(500)
  subtotal        Float // Total nilai return
  refundMethod    PaymentMethod
  refundAmount    Float
  status          ReturnStatus @default(PENDING)
  approvedBy      String?      @db.VarChar(50) // Manager yang approve
  approvedAt      DateTime?
  returnType      String?      @db.VarChar(20) // 'EXCHANGE' or 'REFUND'
  priceDifference Float?       // For exchanges: difference between old and new items
  isOverdue       Boolean      @default(false)
  managerOverride Boolean      @default(false)
  photoUrls       String[]     @default([])
  conditionNote   String?      @db.VarChar(500)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  items            ReturnItem[]
  exchangeItems    ExchangeItem[]
  cashTransactions CashTransaction[]

  @@index([cabangId])
  @@index([cabangId, createdAt])
  @@index([transactionId])
  @@index([status])
  @@map("returns")
}

// Exchange items (items customer wants in exchange)
model ExchangeItem {
  id               String         @id @default(cuid())
  return           Return         @relation(fields: [returnId], references: [id], onDelete: Cascade)
  returnId         String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
  productVariantId String
  productName      String @db.VarChar(255) // Snapshot
  variantInfo      String @db.VarChar(255) // Snapshot
  quantity         Int
  price            Float
  subtotal         Float
  createdAt        DateTime       @default(now())

  @@map("exchange_items")
}

enum ReturnReason {
  DAMAGED // Barang Rusak
  WRONG_ITEM // Salah Barang
  EXPIRED // Kadaluarsa
  CUSTOMER_REQUEST // Permintaan Customer
  OTHER // Lainnya
}

enum ReturnStatus {
  PENDING // Menunggu persetujuan
  REJECTED // Ditolak
  COMPLETED // Disetujui & Selesai (stock sudah dikembalikan)
}

// Item yang diretur
model ReturnItem {
  id               String         @id @default(cuid())
  return           Return         @relation(fields: [returnId], references: [id], onDelete: Cascade)
  returnId         String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
  productVariantId String
  productName      String  @db.VarChar(255) // Snapshot
  variantInfo      String  @db.VarChar(255) // Snapshot
  sku              String? @db.VarChar(100) // Snapshot
  quantity         Int // Jumlah yang diretur
  price            Float // Harga saat transaksi
  subtotal         Float // quantity * price
  createdAt        DateTime       @default(now())

  @@map("return_items")
}

// Cabang/Branch
model Cabang {
  id        String   @id @default(cuid())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId  String
  
  name        String  @db.VarChar(100)
  address   String?   @db.VarChar(500)
  phone     String?   @db.VarChar(20)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users              User[]
  stocks             Stock[]
  transactions       Transaction[]
  returns            Return[]
  cashTransactions   CashTransaction[]
  printerSettings    PrinterSettings?
  requestedOrders    Order[]
  transfersFrom      StockTransfer[]  @relation("TransfersFrom")
  transfersTo        StockTransfer[]  @relation("TransfersTo")
  stockAdjustments   StockAdjustment[]
  stockAlerts        StockAlert[]

  @@unique([tenantId, name])
  @@map("cabang")
}

// Kategori Produk (Seragam, Perlengkapan, dll)
model Category {
  id          String    @id @default(cuid())
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId    String
  name        String    @db.VarChar(100)
  description String?   @db.VarChar(500)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@unique([tenantId, name])
  @@map("categories")
}

// Produk (Baju Seragam SD, Celana, dll)
model Product {
  id          String      @id @default(cuid())
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId    String
  name        String      @db.VarChar(255)
  description String?     @db.VarChar(1000)
  category    Category    @relation(fields: [categoryId], references: [id])
  categoryId  String
  productType ProductType @default(VARIANT) // SINGLE atau VARIANT
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  variants     ProductVariant[]
  variantTypes VariantType[]

  @@index([tenantId])
  @@index([categoryId])
  @@index([tenantId, isActive])
  @@map("products")
}

// Tipe Varian (Ukuran, Warna, dll) - for dynamic variant creation
model VariantType {
  id        String   @id @default(cuid())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  name      String   @db.VarChar(50) // "Ukuran", "Warna", "Material"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  options VariantOption[]

  @@unique([productId, name])
  @@map("variant_types")
}

// Opsi dari Tipe Varian (6, 8, 10 untuk Ukuran, dst)
model VariantOption {
  id            String      @id @default(cuid())
  variantType   VariantType @relation(fields: [variantTypeId], references: [id], onDelete: Cascade)
  variantTypeId String
  value         String      @db.VarChar(100) // "6", "8", "10", "Merah", "Biru"
  createdAt     DateTime    @default(now())

  @@unique([variantTypeId, value])
  @@map("variant_options")
}

enum ProductType {
  SINGLE // Produk tanpa varian (harga di product)
  VARIANT // Produk dengan varian (harga di variant)
}

// Variant Produk (Size/Nomor: 6, 8, 10, dst)
model ProductVariant {
  id           String   @id @default(cuid())
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId    String
  variantName  String   @db.VarChar(150) // "Size | Color | Material" (pipe-separated, supports up to 3 attributes)
  variantValue String   @db.VarChar(255) // "M | Red | Cotton" (pipe-separated values)
  sku          String   @unique @db.VarChar(100) // SKU/Barcode
  
  // Marketplace fields (optional)
  weight       Int?     // Weight in grams (for shipping calculation by marketplace)
  length       Int?     // Length in cm
  width        Int?     // Width in cm
  height       Int?     // Height in cm
  imageUrl     String?  @db.VarChar(500) // External image URL (for marketplace sync)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  stocks             Stock[]
  channelStocks      ChannelStock[]
  transactionItems   TransactionItem[]
  returnItems        ReturnItem[]
  exchangeItems      ExchangeItem[]
  priceDiscrepancies PriceDiscrepancy[]
  orders             Order[]
  stockTransfers     StockTransfer[]
  stockAdjustments   StockAdjustment[]
  stockAlerts        StockAlert[]

  @@unique([productId, variantName, variantValue])
  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

// Stok per Cabang
model Stock {
  id               String         @id @default(cuid())
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  productVariantId String
  cabang           Cabang         @relation(fields: [cabangId], references: [id])
  cabangId         String
  quantity         Int            @default(0)
  price            Float          @default(0) // Price per cabang
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  adjustments StockAdjustment[]

  @@unique([productVariantId, cabangId])
  @@index([cabangId])
  @@index([productVariantId])
  @@map("stocks")
}

// Stock Adjustment History
model StockAdjustment {
  id               String              @id @default(cuid())
  productVariant   ProductVariant      @relation(fields: [productVariantId], references: [id])
  productVariantId String
  stock            Stock               @relation(fields: [stockId], references: [id], onDelete: Cascade)
  stockId          String
  cabang           Cabang              @relation(fields: [cabangId], references: [id])
  cabangId         String
  adjustedBy       User                @relation(fields: [adjustedById], references: [id])
  adjustedById     String
  previousQty      Int // Stok sebelumnya
  newQty           Int // Stok baru
  difference       Int // newQty - previousQty
  reason           AdjustmentReason?
  notes            String? @db.VarChar(500) // Custom reason
  createdAt        DateTime            @default(now())

  @@index([cabangId])
  @@index([cabangId, createdAt])
  @@index([stockId])
  @@map("stock_adjustments")
}

enum AdjustmentReason {
  STOCK_OPNAME // Stok opname
  DAMAGED // Barang rusak
  LOST // Barang hilang
  SUPPLIER_RETURN // Return supplier
  INPUT_ERROR // Koreksi input
  OTHER // Lainnya
}

// Transaksi Penjualan (POS + Marketplace)
model Transaction {
  id             String            @id @default(cuid())
  transactionNo  String            @unique // INV-20251107-0001
  
  // Channel & Status
  channel        SalesChannel?     @relation(fields: [channelId], references: [id])
  channelId      String?           // FK to SalesChannel (null = legacy POS)
  status         TransactionStatus @default(COMPLETED) // Unified status
  
  // Branch & Staff
  cabang         Cabang            @relation(fields: [cabangId], references: [id])
  cabangId       String
  kasir          User?             @relation(fields: [kasirId], references: [id])
  kasirId        String?           // Optional - marketplace tidak perlu kasir
  
  // Customer Info
  customerName   String?  @db.VarChar(100)
  customerPhone  String?  @db.VarChar(20)
  buyerUsername  String?  @db.VarChar(100) // Username pembeli di marketplace
  
  // Amounts
  subtotal       Float
  discount       Float             @default(0)
  tax            Float             @default(0)
  shippingCost   Float             @default(0) // Ongkir
  platformFee    Float             @default(0) // Fee marketplace
  total          Float
  
  // Payment (for POS)
  paymentMethod  PaymentMethod?
  paymentStatus  PaymentStatus     @default(COMPLETED)
  bankName       String?  @db.VarChar(100)  // Nama bank untuk DEBIT/TRANSFER
  referenceNo    String?  @db.VarChar(100)  // Nomor referensi/approval
  cardLastDigits String?  @db.VarChar(4)    // 4 digit terakhir kartu (DEBIT)
  
  // Split Payment (POS only)
  isSplitPayment Boolean           @default(false)
  paymentAmount1 Float?
  paymentMethod2 PaymentMethod?
  paymentAmount2 Float?
  bankName2      String?  @db.VarChar(100)
  referenceNo2   String?  @db.VarChar(100)
  
  // External Marketplace Data
  externalOrderId  String?  @db.VarChar(100) // Order ID dari marketplace
  externalInvoice  String?  @db.VarChar(100) // Invoice/AWB number
  externalStatus   String?  @db.VarChar(50)  // Status asli dari marketplace
  externalData     Json?           // Data tambahan (shipping, courier, etc)
  
  // Device/Platform Source
  deviceSource     String?  @db.VarChar(50) // WEB, ANDROID, IOS, WINDOWS, TOKOPEDIA, SHOPEE, etc
  
  notes          String?    @db.VarChar(1000)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  items              TransactionItem[]
  priceDiscrepancies PriceDiscrepancy[]
  returns            Return[]
  cashTransactions   CashTransaction[]

  @@index([channelId])
  @@index([status])
  @@index([externalOrderId])
  @@index([cabangId, createdAt])
  @@index([kasirId, createdAt])
  @@index([channelId, status])
  @@map("transactions")
}

enum PaymentMethod {
  CASH
  DEBIT
  TRANSFER
  QRIS
}

enum PaymentStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum CashType {
  SALE
  RETURN
  EXPENSE
  DEPOSIT
  WITHDRAW
  OTHER
}

// Cash Transaction for tracking money in/out
model CashTransaction {
  id            String     @id @default(cuid())
  type          CashType
  amount        Float
  description   String?    @db.VarChar(500)
  cabang        Cabang     @relation(fields: [cabangId], references: [id])
  cabangId      String
  return        Return?    @relation(fields: [returnId], references: [id])
  returnId      String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  transactionId String?
  recordedBy    User       @relation(fields: [recordedById], references: [id])
  recordedById  String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([cabangId, createdAt])
  @@index([returnId])
  @@index([transactionId])
  @@map("cash_transactions")
}

// Item per Transaksi
model TransactionItem {
  id               String         @id @default(cuid())
  transaction      Transaction    @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId    String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
  productVariantId String
  productName      String  @db.VarChar(255) // Snapshot nama produk
  variantInfo      String  @db.VarChar(255) // Snapshot variant (Size: 10)
  sku              String? @db.VarChar(100) // SKU snapshot
  quantity         Int
  price            Float // Harga saat transaksi
  subtotal         Float
  createdAt        DateTime       @default(now())

  @@map("transaction_items")
}

// Price Discrepancy - Track price differences from offline transactions
model PriceDiscrepancy {
  id               String         @id @default(cuid())
  transaction      Transaction    @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId    String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
  productVariantId String
  expectedPrice    Float // Current price in database
  actualPrice      Float // Price used in transaction (offline data)
  difference       Float // expectedPrice - actualPrice
  reason           String  @db.VarChar(500) // Explanation
  resolved         Boolean        @default(false)
  resolvedBy       String? @db.VarChar(50) // User ID who resolved
  resolvedAt       DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@map("price_discrepancies")
}

// Global Settings (Tenant-scoped)
model Settings {
  id        String   @id @default(cuid())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId  String
  key       String   @db.VarChar(100)
  value     String   @db.VarChar(1000)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("settings")
}

model PrinterSettings {
  id               String   @id @default(cuid())
  cabangId         String?  @unique
  autoPrintEnabled Boolean  @default(true)
  printerName      String?  @db.VarChar(255)
  paperWidth       Int      @default(80)
  storeName        String   @default("Pelaris.id") @db.VarChar(100)
  branchName       String?  @db.VarChar(100)
  address          String?  @db.VarChar(500)
  phone            String?  @db.VarChar(20)
  footerText1      String?  @db.VarChar(255)
  footerText2      String?  @db.VarChar(255)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  cabang Cabang? @relation(fields: [cabangId], references: [id])

  @@map("printer_settings")
}

// Order Management - Product requests from KASIR
model Order {
  id              String      @id @default(cuid())
  orderNo         String      @unique @db.VarChar(50) // ORD-20251126-0001
  requestedBy     User        @relation("RequestedOrders", fields: [requestedById], references: [id])
  requestedById   String
  cabang          Cabang      @relation(fields: [cabangId], references: [id])
  cabangId        String
  productName     String      @db.VarChar(255)
  productType     ProductType @default(SINGLE)
  categoryId      String?
  categoryName    String?     @db.VarChar(100)
  price           Float?
  quantity        Int?
  status          OrderStatus @default(PENDING)
  notes           String?     @db.VarChar(500)
  rejectionReason String?     @db.VarChar(500)
  processedBy     User?       @relation("ProcessedOrders", fields: [processedById], references: [id])
  processedById   String?
  processedAt     DateTime?
  productVariant  ProductVariant? @relation(fields: [productVariantId], references: [id])
  productVariantId String? // Set when order is approved and product created
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([cabangId])
  @@index([status])
  @@index([cabangId, status])
  @@index([requestedById])
  @@map("orders")
}

enum OrderStatus {
  PENDING // Menunggu proses
  APPROVED // Disetujui, produk dibuat
  REJECTED // Ditolak
}

// Stock Transfer between branches
model StockTransfer {
  id              String         @id @default(cuid())
  transferNo      String         @unique @db.VarChar(50) // TRF-20251126-0001
  productVariant  ProductVariant @relation(fields: [variantId], references: [id])
  variantId       String
  fromCabang      Cabang         @relation("TransfersFrom", fields: [fromCabangId], references: [id])
  fromCabangId    String
  toCabang        Cabang         @relation("TransfersTo", fields: [toCabangId], references: [id])
  toCabangId      String
  quantity        Int
  transferredBy   User           @relation(fields: [transferredById], references: [id])
  transferredById String
  notes           String?        @db.VarChar(500)
  status          TransferStatus @default(COMPLETED)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([fromCabangId])
  @@index([toCabangId])
  @@index([variantId])
  @@index([status])
  @@index([createdAt])
  @@map("stock_transfers")
}

enum TransferStatus {
  PENDING // Menunggu approval
  COMPLETED // Selesai
  CANCELLED // Dibatalkan
}

// Stock Alert (Low Stock Notification)
model StockAlert {
  id               String         @id @default(cuid())
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  productVariantId String
  cabang           Cabang         @relation(fields: [cabangId], references: [id])
  cabangId         String
  minStock         Int // Minimum stock threshold
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([productVariantId, cabangId])
  @@map("stock_alerts")
}
